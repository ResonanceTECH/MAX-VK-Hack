{
    # Для локальной разработки - используем внутренние сертификаты
    # Для продакшена раскомментируйте и укажите email:
    # email your-email@example.com
}

# Для локальной разработки
localhost {
    # Редирект HTTP на HTTPS
    @http {
        protocol http
    }
    redir @http https://{host}{uri} permanent
    
    # TLS настройки для локальной разработки
    # Используем доверенные сертификаты от mkcert
    tls /etc/caddy/ssl/localhost.pem /etc/caddy/ssl/localhost-key.pem
    
    # Проксирование на schedule сервис (/api2)
    handle /api2/* {
        uri strip_prefix /api2
        reverse_proxy schedule:8001 {
            header_up X-Real-IP {remote_host}
        }
    }
    
    handle /api2 {
        reverse_proxy schedule:8001 {
            header_up X-Real-IP {remote_host}
        }
    }
    
    # Проксирование на backend сервис (/api)
    handle /api/* {
        uri strip_prefix /api
        reverse_proxy backend:8000 {
            header_up X-Real-IP {remote_host}
            header_up X-Init-Data {http.request.header.X-Init-Data}
            header_up X-Selected-Role {http.request.header.X-Selected-Role}
        }
    }
    
    handle /api {
        reverse_proxy backend:8000 {
            header_up X-Real-IP {remote_host}
            header_up X-Init-Data {http.request.header.X-Init-Data}
            header_up X-Selected-Role {http.request.header.X-Selected-Role}
        }
    }
    
    # Статические файлы с кешированием
    @static {
        path *.js *.css *.png *.jpg *.jpeg *.gif *.ico *.svg *.woff *.woff2 *.ttf *.eot
    }
    handle @static {
        reverse_proxy frontend:3000
    }
    
    # Все остальное - на frontend (SPA роутинг)
    handle {
        reverse_proxy frontend:3000 {
            header_up X-Real-IP {remote_host}
        }
    }
    
    # Безопасность заголовков
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains"
        X-Frame-Options "SAMEORIGIN"
        X-Content-Type-Options "nosniff"
        X-XSS-Protection "1; mode=block"
    }
    
    # Кеширование статических файлов
    @static_files {
        path *.js *.css *.png *.jpg *.jpeg *.gif *.ico *.svg *.woff *.woff2 *.ttf *.eot
    }
    header @static_files Cache-Control "public, max-age=31536000, immutable"
}

# Для доступа по IP-адресу
178.72.139.15 {
    # Редирект HTTP на HTTPS
    @http {
        protocol http
    }
    redir @http https://{host}{uri} permanent
    
    # TLS настройки - используем тот же сертификат (включает этот IP)
    tls /etc/caddy/ssl/localhost.pem /etc/caddy/ssl/localhost-key.pem
    
    # Проксирование на schedule сервис (/api2)
    handle /api2/* {
        uri strip_prefix /api2
        reverse_proxy schedule:8001 {
            header_up X-Real-IP {remote_host}
        }
    }
    
    handle /api2 {
        reverse_proxy schedule:8001 {
            header_up X-Real-IP {remote_host}
        }
    }
    
    # Проксирование на backend сервис (/api)
    handle /api/* {
        uri strip_prefix /api
        reverse_proxy backend:8000 {
            header_up X-Real-IP {remote_host}
            header_up X-Init-Data {http.request.header.X-Init-Data}
            header_up X-Selected-Role {http.request.header.X-Selected-Role}
        }
    }
    
    handle /api {
        reverse_proxy backend:8000 {
            header_up X-Real-IP {remote_host}
            header_up X-Init-Data {http.request.header.X-Init-Data}
            header_up X-Selected-Role {http.request.header.X-Selected-Role}
        }
    }
    
    # Статические файлы
    @static {
        path *.js *.css *.png *.jpg *.jpeg *.gif *.ico *.svg *.woff *.woff2 *.ttf *.eot
    }
    handle @static {
        reverse_proxy frontend:3000
    }
    
    # Все остальное - на frontend (SPA роутинг)
    handle {
        reverse_proxy frontend:3000 {
            header_up X-Real-IP {remote_host}
        }
    }
    
    # Безопасность заголовков
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains"
        X-Frame-Options "SAMEORIGIN"
        X-Content-Type-Options "nosniff"
        X-XSS-Protection "1; mode=block"
    }
    
    # Кеширование статических файлов
    @static_files {
        path *.js *.css *.png *.jpg *.jpeg *.gif *.ico *.svg *.woff *.woff2 *.ttf *.eot
    }
    header @static_files Cache-Control "public, max-age=31536000, immutable"
}

# Для продакшена (раскомментируйте и настройте домен)
# your-domain.com {
#     # Автоматический HTTPS через Let's Encrypt
#     reverse_proxy /api2/* schedule:8001 {
#         header_up X-Real-IP {remote_host}
#         header_up X-Forwarded-For {remote_host}
#         header_up X-Forwarded-Proto {scheme}
#     }
#     
#     reverse_proxy /api/* backend:8000 {
#         header_up X-Real-IP {remote_host}
#         header_up X-Forwarded-For {remote_host}
#         header_up X-Forwarded-Proto {scheme}
#         header_up X-Init-Data {http.request.header.X-Init-Data}
#         header_up X-Selected-Role {http.request.header.X-Selected-Role}
#     }
#     
#     reverse_proxy frontend:3000 {
#         header_up X-Real-IP {remote_host}
#         header_up X-Forwarded-For {remote_host}
#         header_up X-Forwarded-Proto {scheme}
#     }
#     
#     header {
#         Strict-Transport-Security "max-age=31536000; includeSubDomains"
#         X-Frame-Options "SAMEORIGIN"
#         X-Content-Type-Options "nosniff"
#         X-XSS-Protection "1; mode=block"
#     }
# }

